"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const N=require("./utilities/diff.js"),v=require("./utilities/extractor.js"),h=require("./utilities/kanaConverter.js");var q=(c=>(c[c.REALTIME=0]="REALTIME",c[c.ENTER=1]="ENTER",c))(q||{});function D(c,y,r={observeInterval:30,debug:!1,realtime:!0,enter:!1,clearOnInputEmpty:!1,capturablePatterns:v.CapturableCharacterType.HIRAGANA}){const L=v.generateCapturableRegExp(r.capturablePatterns??v.CapturableCharacterType.HIRAGANA),n=typeof c=="string"?document.querySelector(c):c;if(!n)throw new Error("input element not found");let s=0;const k=r.realtime instanceof HTMLInputElement,A=r.enter instanceof HTMLInputElement,_=!k&&!A;function g(){const e=r.realtime&&(r.realtime===!0||r.realtime instanceof HTMLInputElement&&r.realtime.checked),t=r.enter&&(r.enter===!0||r.enter instanceof HTMLInputElement&&r.enter.checked);s=e||!t?0:1}_&&g(),a("outputTiming",{outputTiming:s,outputTimingIsStatic:_,realtimeIsDynamic:k,enterIsDynamic:A});const u=[],C=e=>{if(typeof e=="string"){const t=document.querySelectorAll(e);for(const l of t)u.push({element:l,type:h.KanaType.Hiragana})}else e instanceof HTMLInputElement?u.push({element:e,type:h.KanaType.Hiragana}):u.push({element:e.element,type:e.type??h.KanaType.Hiragana})};if(Array.isArray(y))for(const e of y)C(e);else C(y);let f=!1,d="",E="",b="";const p=new Array(u.length).fill("");function H(){a("reset"),d="",E="",b="";for(let e=0;e<u.length;e++)p[e]=""}function m(){d=n.value,u.forEach(({element:e},t)=>{p[t]=e.value}),a("setup",n.value,{defaultString:d,activeOutputs:u})}let o;function w(){a("start",{timer:o}),!o&&(o=setInterval(()=>{P()},r.observeInterval??30))}function O(){a("end",{timer:o}),o&&(clearInterval(o),o=void 0)}function P(){const e=n.value;if(a("observe",{observing:f,inputString:e,defaultString:d,currentString:E,outputValues:p}),e==="")return;const t=N.diff(d,e);E!==t.diff&&(E=t.diff,T(E))}function T(e){a("set",{defaultString:d,string:e,inputValue:b,outputValues:p});const t=v.extractor({input:e,patterns:L});t.length===e.length&&(b=t),u.forEach(({element:l,type:R},x)=>{const I=h.kanaConverter(R,b);a("converted",{type:R,string:e,inputValue:b,after:I,before:p[x],bufferKana:l.dataset.bufferKana,bufferOther:l.dataset.bufferOther}),s===0?l.value=p[x]+I:s===1&&B(l,I)})}function K(e){const t=v.extractor({input:e,patterns:L});e&&e===t&&(m(),T(t))}function B(e,t){a("set buffer",{observing:f,element:e,string:t}),f?e.dataset.bufferKana=t:e.dataset.bufferOther=(e.dataset.bufferOther??"")+t}function M(e){a("clear buffer"),e.dataset.bufferOther="",e.dataset.bufferKana=""}function S(e=!1){u.forEach(({element:t})=>{if(e){t.value="",M(t);return}const l=(t.dataset.bufferOther??"")+(t.dataset.bufferKana??"");l&&(t.value+=l,M(t))})}function a(e,...t){if(r.debug){if(t.length===0){console.log("%c[debug]","background-color: #ff6d13; color: #fffafa;",{message:e});return}console.log("%c[debug]","background-color: #ff6d13; color: #fffafa;",{message:e},...t)}}function i(e,...t){if(r.event){if(t.length===0){console.info("%c[event]","background-color: #fffafa; color: #303030;",{message:e});return}console.info("%c[event]","background-color: #fffafa; color: #303030;",{message:e},...t)}}n.addEventListener("focus",e=>{i("focus",{e}),m()}),n.addEventListener("blur",e=>{i("blur",{e}),O()}),n.addEventListener("compositionstart",e=>{i("compositionstart",{e}),m(),w(),f=!0}),n.addEventListener("compositionend",e=>{i("compositionend",{e,inputValue:b}),O(),H(),f=!1,["ã€€"," "].includes(e.data)&&(a("spaces",'"'+e.data+'"'),K(e.data))}),n.addEventListener("beforeinput",e=>{i("beforeinput",{observing:f,e}),!f&&!e.isComposing&&e.data&&K(e.data)}),n.addEventListener("input",e=>{i("input",{observing:f,e})}),n.addEventListener("keydown",e=>{i("keydown",{observing:f,e})}),n.addEventListener("keyup",e=>{if(i("keyup",{observing:f,e},e.code),e.code==="Enter"){let t=!1;r.clearOnInputEmpty&&n.value===""&&(t=!0,H(),T("")),s===1&&S(t)}e.code==="Backspace"&&a("backspace",{outputTiming:s},n.value)}),r.realtime instanceof HTMLInputElement&&r.realtime.addEventListener("change",()=>{a("realtime change"),g(),S()}),r.enter instanceof HTMLInputElement&&r.enter.addEventListener("change",()=>{a("enter change"),g()})}exports.CapturableCharacterType=v.CapturableCharacterType;exports.KanaType=h.KanaType;exports.OutputTiming=q;exports.setupObserver=D;
//# sourceMappingURL=index.js.map
