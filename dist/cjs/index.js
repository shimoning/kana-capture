"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const B=require("./utilities/diff.js"),p=require("./utilities/extractor.js"),E=require("./utilities/kanaConverter.js");var S=(u=>(u[u.REALTIME=0]="REALTIME",u[u.ENTER=1]="ENTER",u))(S||{});function N(u,m,r={observeInterval:30,debug:!1,realtime:!0,enter:!1,clearOnInputEmpty:!1,captureablePatterns:p.CaptureableCharacterType.HIRAGANA}){const I=p.generateCaptureableRegExp(r.captureablePatterns??p.CaptureableCharacterType.HIRAGANA),n=typeof u=="string"?document.querySelector(u):u;if(!n)throw new Error("input element not found");let s=0;const L=r.realtime instanceof HTMLInputElement,A=r.enter instanceof HTMLInputElement,C=!L&&!A;function y(){const e=r.realtime&&(r.realtime===!0||r.realtime instanceof HTMLInputElement&&r.realtime.checked),t=r.enter&&(r.enter===!0||r.enter instanceof HTMLInputElement&&r.enter.checked);s=e||!t?0:1}C&&y(),a("outputTiming",{outputTiming:s,outputTimingIsStatic:C,realtimeIsDynamic:L,enterIsDynamic:A});const c=[],H=e=>{if(typeof e=="string"){const t=document.querySelectorAll(e);for(const f of t)c.push({element:f,type:E.KanaType.Hiragana})}else e instanceof HTMLInputElement?c.push({element:e,type:E.KanaType.Hiragana}):c.push({element:e.element,type:e.type??E.KanaType.Hiragana})};if(Array.isArray(m))for(const e of m)H(e);else H(m);let i=!1,o="",v="",d="";const b=new Array(c.length).fill("");function _(){a("reset"),o="",v="",d="";for(let e=0;e<c.length;e++)b[e]=""}function g(){o=n.value,c.forEach(({element:e},t)=>{b[t]=e.value}),a("setup",n.value,{defaultString:o,activeOutputs:c})}let l;function q(){a("start",{timer:l}),!l&&(l=setInterval(()=>{x()},r.observeInterval??30))}function O(){a("end",{timer:l}),l&&(clearInterval(l),l=void 0)}function x(){const e=n.value;if(a("observe",{observing:i,inputString:e,defaultString:o,currentString:v,outputValues:b}),e==="")return;const t=B.diff(o,e);v!==t.diff&&(v=t.diff,i&&h(v))}function h(e){a("set",{defaultString:o,string:e,inputValue:d,outputValues:b});const t=p.extractor({input:e,patterns:I});t.length===e.length&&(d=t),c.forEach(({element:f,type:k},R)=>{const T=E.kanaConverter(k,d);a("converted",{type:k,string:e,inputValue:d,after:T,before:b[R],bufferKana:f.dataset.bufferKana,bufferOther:f.dataset.bufferOther}),s===0?f.value=b[R]+T:s===1&&P(f,T)})}function P(e,t){i?e.dataset.bufferKana=t:e.dataset.bufferOther=(e.dataset.bufferOther??"")+t}function K(e){console.log("clear buffer"),e.dataset.bufferOther="",e.dataset.bufferKana=""}function M(e=!1){c.forEach(({element:t})=>{if(e){t.value="",K(t);return}const f=(t.dataset.bufferOther??"")+(t.dataset.bufferKana??"");f&&(t.value+=f,K(t))})}function a(e,...t){if(r.debug){if(t.length===0){console.info("debug",{message:e});return}console.info("debug",{message:e},...t)}}n.addEventListener("focus",()=>{a("focus"),g()}),n.addEventListener("blur",()=>{a("blur"),O()}),n.addEventListener("compositionstart",e=>{a("compositionstart",{e}),g(),q(),i=!0}),n.addEventListener("compositionend",e=>{a("compositionend",{e}),O(),h(d),_(),i=!1}),n.addEventListener("beforeinput",e=>{if(a("beforeinput",{observing:i,e}),!i&&!e.isComposing&&e.data){const t=e.data,f=p.extractor({input:t,patterns:I});t&&t===f&&(g(),h(t))}}),n.addEventListener("keyup",e=>{if(a("keyup",e.code,{observing:i,e}),e.code==="Enter"){let t=!1;r.clearOnInputEmpty&&n.value===""&&(t=!0,_(),h("")),s===1&&M(t)}e.code==="Backspace"&&a("backspace",{outputTiming:s},n.value)}),r.realtime instanceof HTMLInputElement&&r.realtime.addEventListener("change",()=>{a("realtime change"),y(),M()}),r.enter instanceof HTMLInputElement&&r.enter.addEventListener("change",()=>{a("enter change"),y()})}exports.CaptureableCharacterType=p.CaptureableCharacterType;exports.KanaType=E.KanaType;exports.OutputTiming=S;exports.setupObserver=N;
//# sourceMappingURL=index.js.map
