{"version":3,"file":"observer.js","sources":["../../src/observer.ts"],"sourcesContent":["import { diff } from './utilities/diff'\nimport { CaptureableCharacterPattern, CaptureableCharacterType, extractor, generateCaptureableRegExp } from './utilities/extractor'\nimport { kanaConverter, KanaType } from './utilities/kanaConverter'\nexport { KanaType, CaptureableCharacterType }\nexport type { CaptureableCharacterPattern }\n\nexport type Options = {\n  observeInterval?: number; // unit: ms\n  debug?: boolean; // logging if true\n  realtime?: boolean | HTMLInputElement;\n  enter?: boolean | HTMLInputElement;\n  clearOnInputEmpty?: boolean;\n  captureablePatterns?: CaptureableCharacterPattern | CaptureableCharacterPattern[];\n};\nexport type Output = {\n  element: HTMLInputElement;\n  type?: KanaType;\n};\nexport enum OutputTiming {\n  REALTIME, // default and priority\n  ENTER,\n}\n\nexport function setupObserver(\n  input: HTMLInputElement,\n  outputs: (Output | string)[] | string,\n  options: Options = {\n    observeInterval: 30,\n    debug: false,\n    realtime: true,\n    enter: false,\n    clearOnInputEmpty: false,\n    captureablePatterns: CaptureableCharacterType.HIRAGANA,\n  },\n) {\n  const captureablePatterns = generateCaptureableRegExp(\n    options.captureablePatterns ?? CaptureableCharacterType.HIRAGANA,\n  )\n\n  let outputTiming = OutputTiming.REALTIME\n  function _checkOutputTiming() {\n    const realtime =\n      options.realtime &&\n      (options.realtime === true ||\n        (options.realtime instanceof HTMLInputElement && options.realtime.checked))\n    const enter =\n      options.enter &&\n      (options.enter === true ||\n        (options.enter instanceof HTMLInputElement && options.enter.checked))\n    outputTiming = realtime || !enter\n      ? OutputTiming.REALTIME // realtime=true, realtime=false & enter=false\n      : OutputTiming.ENTER  // realtime=false & enter=true\n  }\n\n  // 出力先を整える\n  const activeOutputs: Required<Output>[] = []\n  if (typeof outputs === 'string') {\n    const elements = document.querySelectorAll<HTMLInputElement>(outputs)\n    for (const element of elements) {\n      activeOutputs.push({ element, type: KanaType.Hiragana })\n    }\n  } else {\n    for (const output of outputs) {\n      if (typeof output === 'string') {\n        const elements = document.querySelectorAll<HTMLInputElement>(output)\n        for (const element of elements) {\n          activeOutputs.push({ element, type: KanaType.Hiragana })\n        }\n      } else {\n        activeOutputs.push({\n          element: output.element,\n          type: output.type ?? KanaType.Hiragana,\n        })\n      }\n    }\n  }\n\n  let observing: boolean = false\n  let defaultString: string = ''\n  let currentString: string = ''\n\n  let inputValue: string = ''\n  const outputValues: string[] = new Array(activeOutputs.length).fill('')\n  /**\n   * 初期化\n   * @returns void\n   */\n  function _reset() {\n    _debug('reset')\n    defaultString = ''\n    currentString = ''\n\n    inputValue = ''\n    for (let i = 0; i < activeOutputs.length; i++) {\n      outputValues[i] = ''\n    }\n  }\n  /**\n   * 初期入力値を保存する\n   * @returns void\n   */\n  function _setup() {\n    defaultString = input.value\n    activeOutputs.forEach(({ element }, index) => {\n      outputValues[index] = element.value\n    })\n    _debug('setup', input.value, { defaultString, activeOutputs })\n  }\n\n  let timer: number | undefined\n  /**\n   * 監視を開始する\n   * @returns void\n   */\n  function _start() {\n    _debug('start', { timer })\n    if (timer) {\n      return\n    }\n    timer = setInterval(() => {\n      _checkOutputTiming()\n      _observe()\n    }, options.observeInterval ?? 30)\n  }\n  /**\n   * 監視を終了する\n   * @returns void\n   */\n  function _end() {\n    _debug('end', { timer })\n    if (timer) {\n      clearInterval(timer)\n      timer = undefined\n    }\n  }\n\n  /**\n   * 入力を監視する\n   * @return void\n   */\n  function _observe() {\n    let inputString = input.value\n    _debug('observe', { observing, inputString, defaultString, currentString, outputValues })\n\n    // 空文字の場合は何もしない\n    if (inputString === '') {\n      return\n    }\n\n    // すでに入力されている文字を取り除く\n    const diffResult = diff(defaultString, inputString)\n    inputString = diffResult.diff\n\n    // 同じだったら何もしない\n    if (currentString === inputString) {\n      return\n    }\n    currentString = inputString\n\n    // 変換完了している場合は何もしない\n    if (!observing) {\n      return\n    }\n\n    // セットする\n    _set(currentString)\n  }\n\n  /**\n   * セットする\n   * @param string\n   */\n  function _set(string: string) {\n    _debug('set', { defaultString, string, inputValue, outputValues })\n    const extracted = extractor({\n      input: string,\n      patterns: captureablePatterns,\n    })\n    if (extracted.length === string.length) {\n      inputValue = extracted\n    }\n\n    activeOutputs.forEach(({ element, type }, index) => {\n      const converted = kanaConverter(type, inputValue)\n      _debug('converted', { type, string, inputValue, after: converted, before: outputValues[index] })\n      if (outputTiming === OutputTiming.REALTIME) {\n        element.value = outputValues[index] + converted\n      } else if (outputTiming === OutputTiming.ENTER) {\n        element.dataset['kana'] = outputValues[index] = converted\n      }\n    })\n  }\n\n  /**\n   * 反映する\n   * @returns void\n   */\n  function _reflect() {\n    activeOutputs.forEach(({ element }) => {\n      if (element.dataset['kana']) {\n        element.value += element.dataset['kana']\n        element.removeAttribute('data-kana')\n      }\n    })\n  }\n\n  /**\n   * デバッグログ\n   * @param message\n   * @param args\n   * @return void\n   */\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  function _debug(message: string, ...args: any[]) {\n    if (!options.debug) {\n      return\n    }\n    if (args.length === 0) {\n      console.info('debug', { message })\n      return\n    }\n    console.info('debug', { message }, ...args)\n  }\n\n  /**\n   * Event listeners\n   */\n  input.addEventListener('focus', () => {\n    _debug('focus')\n    _setup()\n  })\n  input.addEventListener('blur', () => {\n    _debug('blur')\n    _end()\n  })\n  input.addEventListener('compositionstart', (e: CompositionEvent) => {\n    _debug('compositionstart', { e })\n    _setup()\n    _start()\n    observing = true\n  })\n  input.addEventListener('compositionend', (e: CompositionEvent) => {\n    _debug('compositionend', { e })\n    _end()\n    _set(inputValue)\n    _reset()\n    observing = false\n  })\n  input.addEventListener('keydown', (e: KeyboardEvent) => {\n    _debug('keydown', { observing, e })\n    if (!observing) {\n      _setup()\n    }\n\n    if (e.code === 'Enter') {\n      if (options.clearOnInputEmpty && input.value === '') {\n        _reset()\n        _set('')\n      } else {\n        if (outputTiming === OutputTiming.ENTER) {\n          _reflect()\n        }\n      }\n    }\n  })\n  input.addEventListener('keyup', (e: Event) => {\n    _debug('keyup', { observing, e })\n  })\n}\n"],"names":["OutputTiming","OutputTiming2","setupObserver","input","outputs","options","CaptureableCharacterType","captureablePatterns","generateCaptureableRegExp","outputTiming","_checkOutputTiming","realtime","enter","activeOutputs","elements","element","KanaType","output","observing","defaultString","currentString","inputValue","outputValues","_reset","_debug","i","_setup","index","timer","_start","_observe","_end","inputString","diff","_set","string","extracted","extractor","type","converted","kanaConverter","_reflect","message","args"],"mappings":"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"}