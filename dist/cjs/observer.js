"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const K=require("./utilities/diff.js"),v=require("./utilities/extractor.js"),y=require("./utilities/kanaConverter.js");var S=(c=>(c[c.REALTIME=0]="REALTIME",c[c.ENTER=1]="ENTER",c))(S||{});function O(c,h,r={observeInterval:30,debug:!1,realtime:!0,enter:!1,clearOnInputEmpty:!1,captureablePatterns:v.CaptureableCharacterType.HIRAGANA}){const g=v.generateCaptureableRegExp(r.captureablePatterns??v.CaptureableCharacterType.HIRAGANA),_=g.source.includes("　"),H=g.source.includes(" "),a=typeof c=="string"?document.querySelector(c):c;if(!a)throw new Error("input element not found");let b=0;function R(){const e=r.realtime&&(r.realtime===!0||r.realtime instanceof HTMLInputElement&&r.realtime.checked),t=r.enter&&(r.enter===!0||r.enter instanceof HTMLInputElement&&r.enter.checked);b=e||!t?0:1}const l=[],A=e=>{if(typeof e=="string"){const t=document.querySelectorAll(e);for(const m of t)l.push({element:m,type:y.KanaType.Hiragana})}else e instanceof HTMLInputElement?l.push({element:e,type:y.KanaType.Hiragana}):l.push({element:e.element,type:e.type??y.KanaType.Hiragana})};if(Array.isArray(h))for(const e of h)A(e);else A(h);let u=!1,f="",d="",o="";const s=new Array(l.length).fill("");function I(){n("reset"),f="",d="",o="";for(let e=0;e<l.length;e++)s[e]=""}function E(){f=a.value,l.forEach(({element:e},t)=>{s[t]=e.value}),n("setup",a.value,{defaultString:f,activeOutputs:l})}let i;function w(){n("start",{timer:i}),!i&&(i=setInterval(()=>{R(),M()},r.observeInterval??30))}function C(){n("end",{timer:i}),i&&(clearInterval(i),i=void 0)}function M(){const e=a.value;if(n("observe",{observing:u,inputString:e,defaultString:f,currentString:d,outputValues:s}),e==="")return;const t=K.diff(f,e);d!==t.diff&&(d=t.diff,u&&p(d))}function p(e){n("set",{defaultString:f,string:e,inputValue:o,outputValues:s});const t=v.extractor({input:e,patterns:g});t.length===e.length&&(o=t),l.forEach(({element:m,type:L},k)=>{const T=y.kanaConverter(L,o);n("converted",{type:L,string:e,inputValue:o,after:T,before:s[k]}),b===0?m.value=s[k]+T:b===1&&(m.dataset.kana=s[k]=T)})}function q(){l.forEach(({element:e})=>{e.dataset.kana&&(e.value+=e.dataset.kana,e.removeAttribute("data-kana"))})}function n(e,...t){if(r.debug){if(t.length===0){console.info("debug",{message:e});return}console.info("debug",{message:e},...t)}}a.addEventListener("focus",()=>{n("focus"),E()}),a.addEventListener("blur",()=>{n("blur"),C()}),a.addEventListener("compositionstart",e=>{n("compositionstart",{e}),E(),w(),u=!0}),a.addEventListener("compositionend",e=>{n("compositionend",{e}),C(),p(o),I(),u=!1}),a.addEventListener("keydown",e=>{n("keydown",{observing:u,e})}),a.addEventListener("keyup",e=>{if(n("keyup",{observing:u,e}),e.code==="Enter")r.clearOnInputEmpty&&a.value===""?(I(),p("")):b===1&&q();else if(!u&&e.code==="Space"){const t=a.value.slice(-1);(_&&t==="　"||H&&t===" ")&&(E(),p(t))}})}exports.CaptureableCharacterType=v.CaptureableCharacterType;exports.KanaType=y.KanaType;exports.OutputTiming=S;exports.setupObserver=O;
//# sourceMappingURL=observer.js.map
