"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const S=require("./utilities/diff.js"),d=require("./utilities/extractor.js"),v=require("./utilities/kanaConverter.js");var I=(t=>(t[t.REALTIME=0]="REALTIME",t[t.ENTER=1]="ENTER",t))(I||{});function q(t,y,n={observeInterval:30,debug:!1,realtime:!0,enter:!1,clearOnInputEmpty:!1,captureablePatterns:d.CaptureableCharacterType.HIRAGANA}){const C=d.generateCaptureableRegExp(n.captureablePatterns??d.CaptureableCharacterType.HIRAGANA);let p=0;function L(){const e=n.realtime&&(n.realtime===!0||n.realtime instanceof HTMLInputElement&&n.realtime.checked),r=n.enter&&(n.enter===!0||n.enter instanceof HTMLInputElement&&n.enter.checked);p=e||!r?0:1}const l=[];if(typeof y=="string"){const e=document.querySelectorAll(y);for(const r of e)l.push({element:r,type:v.KanaType.Hiragana})}else for(const e of y)if(typeof e=="string"){const r=document.querySelectorAll(e);for(const b of r)l.push({element:b,type:v.KanaType.Hiragana})}else l.push({element:e.element,type:e.type??v.KanaType.Hiragana});let u=!1,o="",i="",s="";const c=new Array(l.length).fill("");function T(){a("reset"),o="",i="",s="";for(let e=0;e<l.length;e++)c[e]=""}function E(){o=t.value,l.forEach(({element:e},r)=>{c[r]=e.value}),a("setup",t.value,{defaultString:o,activeOutputs:l})}let f;function R(){a("start",{timer:f}),!f&&(f=setInterval(()=>{L(),_()},n.observeInterval??30))}function k(){a("end",{timer:f}),f&&(clearInterval(f),f=void 0)}function _(){let e=t.value;a("observe",{observing:u,inputString:e,defaultString:o,currentString:i,outputValues:c}),!(e===""||(e=S.diff(o,e).diff,i===e))&&(i=e,u&&m(i))}function m(e){a("set",{defaultString:o,string:e,inputValue:s,outputValues:c});const r=d.extractor({input:e,patterns:C});r.length===e.length&&(s=r),l.forEach(({element:b,type:A},g)=>{const h=v.kanaConverter(A,s);a("converted",{type:A,string:e,inputValue:s,after:h,before:c[g]}),p===0?b.value=c[g]+h:p===1&&(b.dataset.kana=c[g]=h)})}function H(){l.forEach(({element:e})=>{e.dataset.kana&&(e.value+=e.dataset.kana,e.removeAttribute("data-kana"))})}function a(e,...r){if(n.debug){if(r.length===0){console.info("debug",{message:e});return}console.info("debug",{message:e},...r)}}t.addEventListener("focus",()=>{a("focus"),E()}),t.addEventListener("blur",()=>{a("blur"),k()}),t.addEventListener("compositionstart",e=>{a("compositionstart",{e}),E(),R(),u=!0}),t.addEventListener("compositionend",e=>{a("compositionend",{e}),k(),m(s),T(),u=!1}),t.addEventListener("keydown",e=>{a("keydown",{observing:u,e}),u||E(),e.code==="Enter"&&(n.clearOnInputEmpty&&t.value===""?(T(),m("")):p===1&&H())}),t.addEventListener("keyup",e=>{a("keyup",{observing:u,e})})}exports.CaptureableCharacterType=d.CaptureableCharacterType;exports.KanaType=v.KanaType;exports.OutputTiming=I;exports.setupObserver=q;
//# sourceMappingURL=observer.js.map
