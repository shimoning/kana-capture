"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const q=require("./utilities/diff.js"),p=require("./utilities/extractor.js"),v=require("./utilities/kanaConverter.js");var L=(l=>(l[l.REALTIME=0]="REALTIME",l[l.ENTER=1]="ENTER",l))(L||{});function w(l,E,r={observeInterval:30,debug:!1,realtime:!0,enter:!1,clearOnInputEmpty:!1,captureablePatterns:p.CaptureableCharacterType.HIRAGANA}){const _=p.generateCaptureableRegExp(r.captureablePatterns??p.CaptureableCharacterType.HIRAGANA),a=typeof l=="string"?document.querySelector(l):l;if(!a)throw new Error("input element not found");let y=0;function R(){const e=r.realtime&&(r.realtime===!0||r.realtime instanceof HTMLInputElement&&r.realtime.checked),n=r.enter&&(r.enter===!0||r.enter instanceof HTMLInputElement&&r.enter.checked);y=e||!n?0:1}const u=[],k=e=>{if(typeof e=="string"){const n=document.querySelectorAll(e);for(const b of n)u.push({element:b,type:v.KanaType.Hiragana})}else e instanceof HTMLInputElement?u.push({element:e,type:v.KanaType.Hiragana}):u.push({element:e.element,type:e.type??v.KanaType.Hiragana})};if(Array.isArray(E))for(const e of E)k(e);else k(E);let c=!1,s="",d="",o="";const f=new Array(u.length).fill("");function A(){t("reset"),s="",d="",o="";for(let e=0;e<u.length;e++)f[e]=""}function m(){s=a.value,u.forEach(({element:e},n)=>{f[n]=e.value}),t("setup",a.value,{defaultString:s,activeOutputs:u})}let i;function H(){t("start",{timer:i}),!i&&(i=setInterval(()=>{R(),S()},r.observeInterval??30))}function I(){t("end",{timer:i}),i&&(clearInterval(i),i=void 0)}function S(){let e=a.value;t("observe",{observing:c,inputString:e,defaultString:s,currentString:d,outputValues:f}),!(e===""||(e=q.diff(s,e).diff,d===e))&&(d=e,c&&h(d))}function h(e){t("set",{defaultString:s,string:e,inputValue:o,outputValues:f});const n=p.extractor({input:e,patterns:_});n.length===e.length&&(o=n),u.forEach(({element:b,type:C},g)=>{const T=v.kanaConverter(C,o);t("converted",{type:C,string:e,inputValue:o,after:T,before:f[g]}),y===0?b.value=f[g]+T:y===1&&(b.dataset.kana=f[g]=T)})}function M(){u.forEach(({element:e})=>{e.dataset.kana&&(e.value+=e.dataset.kana,e.removeAttribute("data-kana"))})}function t(e,...n){if(r.debug){if(n.length===0){console.info("debug",{message:e});return}console.info("debug",{message:e},...n)}}a.addEventListener("focus",()=>{t("focus"),m()}),a.addEventListener("blur",()=>{t("blur"),I()}),a.addEventListener("compositionstart",e=>{t("compositionstart",{e}),m(),H(),c=!0}),a.addEventListener("compositionend",e=>{t("compositionend",{e}),I(),h(o),A(),c=!1}),a.addEventListener("keydown",e=>{t("keydown",{observing:c,e}),c||m(),e.code==="Enter"&&(r.clearOnInputEmpty&&a.value===""?(A(),h("")):y===1&&M())}),a.addEventListener("keyup",e=>{t("keyup",{observing:c,e})})}exports.CaptureableCharacterType=p.CaptureableCharacterType;exports.KanaType=v.KanaType;exports.OutputTiming=L;exports.setupObserver=w;
//# sourceMappingURL=observer.js.map
